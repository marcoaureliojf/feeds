/*
 * Framework7 Feeds 1.0.0
 * Framework7 Feeds plugin brings easy RSS feeds integration into Framework7 app
 *
 * http://www.idangero.us/framework7/
 *
 * Copyright 2014, Vladimir Kharlampidi
 * The iDangero.us
 * http://www.idangero.us/
 *
 * Licensed under MIT
 *
 * Released on: December 9, 2014
*/
Framework7.prototype.plugins.feeds=function(a){"use strict";function b(b){c(b.container).find(".feeds-init").each(function(){var b=c(this);a.feeds(this,{url:b.attr("data-url"),openIn:b.attr("data-openIn")||void 0,virtualList:b.attr("data-virtualList")||void 0,listTemplate:b.attr("data-listTemplate")&&a.templates&&a.templates[b.attr("data-listTemplate")]||void 0,itemPageTemplate:b.attr("data-itemPageTemplate")&&a.templates&&a.templates[b.attr("data-itemPageTemplate")]||void 0,itemPopupTemplate:b.attr("data-itemPopupTemplate")&&a.templates&&a.templates[b.attr("data-itemPopupTemplate")]||void 0})})}var c=window.Dom7,d=window.Template7,e=function(b,e){var f=this,g={openIn:"page",formatDate:function(a){a=new Date(a);var b="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");return b[a.getMonth(a)]+" "+a.getDate(a)+", "+a.getFullYear()}};e=e||{};for(var h in g)"undefined"==typeof e[h]&&(e[h]=g[h]);f.params=e,f.data={},f.container=c(b);var i='<ul>{{#each items}}<li><a href="#" class="item-link item-content feeds-item-link" data-index="{{@index}}"><div class="item-inner"><div class="item-title">{{title}}</div><div class="item-after">{{formattedDate}}</div></div></a></li>{{/each}}</ul>',j='<li><a href="#" class="item-link item-content feeds-item-link" data-index="{{@index}}"><div class="item-inner"><div class="item-title">{{title}}</div><div class="item-after">{{formattedDate}}</div></div></a></li>',k='<div class="navbar"><div class="navbar-inner"><div class="left sliding"><a href="#" class="back link"><i class="icon icon-back"></i><span>Back</span></a></div><div class="center sliding">{{title}}</div></div></div>',l="static";f.container.parents(".navbar-fixed").length>0&&(l="fixed"),f.container.parents(".navbar-through").length>0&&(l="through");var m=("through"===l?k:"")+'<div class="page feeds-page '+("fixed"===l?"navbar-fixed":"")+'" data-page="feeds-page-{{index}}">'+("fixed"===l?k:"")+'<div class="page-content">'+("static"===l?k:"")+'<div class="content-block"><a href="{{link}}" class="external" target="_blank">{{title}}</a><br><small>{{formattedDate}}</small></div><div class="content-block"><div class="content-block-inner">{{description}}</div></div></div></div>',n='<div class="popup"><div class="view navbar-fixed"><div class="navbar"><div class="navbar-inner"><div class="left sliding"><a href="#" class="close-popup link"><i class="icon icon-back"></i><span>Close</span></a></div><div class="center sliding">{{title}}</div></div></div><div class="pages"><div class="page feeds-page" data-page="feeds-page-{{index}}"><div class="page-content"><div class="content-block"><a href="{{link}}" class="external" target="_blank">{{title}}</a><br><small>{{formattedDate}}</small></div><div class="content-block"><div class="content-block-inner">{{description}}</div></div></div></div></div></div></div>';return f.params.listTemplate?"function"==typeof f.params.listTemplate?f.listTemplate=f.params.listTemplate:"string"==typeof f.params.listTemplate&&(f.listTemplate=d.compile(f.params.listTemplate)):f.listTemplate=d.compile(i),f.params.itemPageTemplate?"function"==typeof f.params.itemPageTemplate?f.itemPageTemplate=f.params.itemPageTemplate:"string"==typeof f.params.itemPageTemplate&&(f.itemPageTemplate=d.compile(f.params.itemPageTemplate)):f.itemPageTemplate=d.compile(m),f.params.itemPopupTemplate?"function"==typeof f.params.itemPopupTemplate?f.itemPopupTemplate=f.params.itemPopupTemplate:"string"==typeof f.params.itemPopupTemplate&&(f.itemPopupTemplate=d.compile(f.params.itemPopupTemplate)):f.itemPopupTemplate=d.compile(n),f.loadFeed=function(b){f.params.onAjaxStart&&f.params.onAjaxStart(f),c.get(f.params.url,function(d){f.params.onAjaxComplete&&f.params.onAjaxComplete(f,d);var e=new DOMParser,g=e.parseFromString(d,"text/xml"),h=c(g).find("rss > channel");if(0!==h.length){f.data={title:h.children("title").text(),link:h.children("link").text(),description:h.children("description").text().replace("<![CDATA[","").replace("]]>",""),copyright:h.children("copyright").text(),image:{url:h.children("image").children("url").text(),title:h.children("image").children("title").text(),link:h.children("image").children("link").text(),width:h.children("image").children("width").text(),height:h.children("image").children("height").text()},items:[]};var i=h.find("item");i.each(function(a,b){var d=c(b),e={title:d.children("title").text().replace("<![CDATA[","").replace("]]>",""),link:d.children("link").text(),description:d.children("description").text().replace("<![CDATA[","").replace("]]>",""),pubDate:d.children("pubDate").text(),formattedDate:f.params.formatDate(d.children("pubDate").text()),guid:d.children("guid").text(),index:f.data.items.length};f.params.customItemFields&&f.params.customItemFields.length>0&&d.children().each(function(){for(var a=0;a<f.params.customItemFields.length;a++){var b=f.params.customItemFields[a].split("||")[0],d=f.params.customItemFields[a].split("||")[1];this.nodeName===b&&(e[b.replace(/:/g,"")]=d?this.getAttribute(d):c(this).text().replace("<![CDATA[","").replace("]]>",""))}}),f.data.items.push(e)}),f.params.virtualList?b?f.virtualList.replaceAllItems(f.data.items):(("true"===f.params.virtualList||f.params.virtualList===!0)&&(f.params.virtualList={}),f.params.virtualList.items=f.data.items,f.params.virtualList.template=f.params.virtualList.template||j,f.virtualList=a.virtualList(f.container,f.params.virtualList)):f.container.html(f.listTemplate(f.data)),b&&a.pullToRefreshDone(f.container.parents(".pull-to-refresh-content"))}})},f.refreshFeed=function(){return f.loadFeed(!0)},f.openItem=function(b){if("page"===f.params.openIn){var c=f.container.parents("."+a.params.viewClass)[0].f7View;if(!c)return;c.router.load({template:f.itemPageTemplate,context:b})}else"popup"===f.params.openIn&&a.popup(f.itemPopupTemplate(b))},f.container.on("click","a.feeds-item-link",function(a){a.preventDefault();var b=c(this).data("index");f.openItem(f.data.items[b])}),f.container.parents(".pull-to-refresh-content").on("refresh",function(){c(this);f.refreshFeed()}),f.loadFeed(),f.container[0].f7Feed=f,f};return a.feeds=function(a,b){return new e(a,b)},{hooks:{pageInit:b}}};